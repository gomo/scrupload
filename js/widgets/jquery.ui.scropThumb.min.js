(function(a){a.widget("ui.scropThumb",{options:{scrupload:{},additional_width:50,path_key_name:"path",default_select_max:true,data_type:"json"},_create:function(){var b=this;b.element.scrupload(a.extend(b.options.scrupload,{onSelect:function(c,d){b._trigger("onImageSelect",null,{element:b.element,scrupload:d,options:b.options})},onFileComplete:function(f,g){var i=a.parseJSON(g.response),e,h,d,c;if(i.error){b._trigger("onUploadError",null,{element:b.element,response:i,options:b.options});return}c=b._trigger("onLoadImage",null,{element:b.element,response:i,options:b.options});if(c===false){return}b.image_path=i[b.options.path_key_name];var d=a("<div />").appendTo(document.body).css("position","absolute").css("top","-10000px").css("left","-10000px");e=a('<img src="'+b.image_path+'" />').appendTo(d);h=a('<img src="'+b.image_path+'" />').appendTo(d);e.load(function(){var j={width:e.width(),height:e.height()};b.dialog=a("<div />").appendTo(document.body).append(b.options.dialog_template.html());b.dialog.find(".scr_thumb_image").append(e).width(j.width).height(j.height);b.dialog.find(".scr_thumb_preview").width(b.options.width).height(b.options.height).css("overflow","hidden").append(h);d.remove();delete d;b.dialog.dialog(a.extend(b.options.dialog,{width:j.width+b.options.width+b.options.additional_width,close:function(k,l){b._closeDialog()},open:function(k,l){b._initJcrop(e,h,j)}}));b.dialog.find(".sdx_thumb_button").click(function(){a.ajax({type:"POST",url:b.options.url,dataType:b.options.data_type,data:{path:b.image_path,coords:b.coords,size:{w:b.options.width,h:b.options.height}},success:function(k){b._trigger("onCropSuccess",null,{dialog:b.dialog,response:k});b._closeDialog()},error:function(k,m,l){b._trigger("onCropError",null,{element:b.element,xml_http_request:k,text_status:m,error_thrown:l,options:b.options});if(window.console){console.info("Ajax error",k)}b._closeDialog()}});return false});b.dialog.find("*").disableSelection()})}}))},_closeDialog:function(){this._trigger("onDialogClose",null,{element:this.element,dialog:this.dialog,options:this.options});this.dialog.dialog("destroy");this.dialog.remove();this.dialog=null},_initJcrop:function(e,g,f){var h=false,d,c=this;d=function(k){if(!h){c.dialog.find(".jcrop-holder *").disableSelection();h=true}c.coords=k;var l=f.width/k.w;var j=f.height/k.h;var i=Math.round(l*c.options.width);var m=Math.round(j*c.options.height);g.css({width:i+"px",height:m+"px",marginLeft:"-"+Math.round(k.x*(i/f.width))+"px",marginTop:"-"+Math.round(k.y*(m/f.height))+"px"})};var b=c.options.default_select_max?[0,0,f.width,null]:[0,0,c.options.width,c.options.height];setTimeout(function(){e.Jcrop({onChange:d,onSelect:d,aspectRatio:c.options.width/c.options.height,minSize:[c.options.width,c.options.height],setSelect:b})},100)},destroy:function(){if(this.dialog){this.dialog.dialog("destroy");this.dialog.remove()}this.image_path=undefined;this.coords=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);