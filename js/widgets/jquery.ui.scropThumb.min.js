(function(a){a.widget("ui.scropThumb",{options:{scrupload:{},additional_width:50,path_key_name:"path"},_create:function(){var b=this;b.element.scrupload(a.extend(b.options.scrupload,{onFileComplete:function(f,g){var i=a.parseJSON(g.response),e,h,d,c;if(i.error){b._trigger("onUploadError",null,{element:b.element,response:i,options:b.options});return}c=b._trigger("onLoadImage",null,{element:b.element,response:i,options:b.options});if(c===false){return}b.image_path=i[b.options.path_key_name];var d=a("<div />").appendTo(document.body).css("position","absolute").css("top","-10000px").css("left","-10000px");e=a('<img src="'+b.image_path+'" />').appendTo(d);h=a('<img src="'+b.image_path+'" />').appendTo(d);e.load(function(){var j={width:e.width(),height:e.height()};b.dialog=a("<div />").appendTo(document.body).append(b.options.dialog_template.html());b.dialog.find(".scr_thumb_image").append(e).width(j.width).height(j.height);b.dialog.find(".scr_thumb_preview").width(b.options.width).height(b.options.height).css("overflow","hidden").append(h);d.remove();delete d;b.dialog.dialog(a.extend(b.options.dialog,{width:j.width+b.options.width+b.options.additional_width,close:function(k,l){b._closeDialog()}}));b.dialog.find(".sdx_thumb_button").click(function(){a.ajax({type:"POST",url:b.options.url,data:{path:b.image_path,coords:b.coords,size:{w:b.options.width,h:b.options.height}},success:function(k){b._trigger("onSubmit",null,{dialog:b.dialog,response:k});b._closeDialog()},error:function(k,m,l){b._trigger("onCropError",null,{element:b.element,xml_http_request:k,text_status:m,error_thrown:l,options:b.options});if(window.console){console.info("Ajax error",k)}b._closeDialog()}});return false});b.dialog.find("*").disableSelection();b._initJcrop(e,h,j)})}}))},_closeDialog:function(){this.dialog.dialog("destroy");this.dialog.remove();this.dialog=null},_initJcrop:function(d,f,e){var g=false,c,b=this;c=function(j){if(!g){b.dialog.find(".jcrop-holder *").disableSelection();g=true}b.coords=j;var k=e.width/j.w;var i=e.height/j.h;var h=Math.round(k*b.options.width);var l=Math.round(i*b.options.height);f.css({width:h+"px",height:l+"px",marginLeft:"-"+Math.round(j.x*(h/e.width))+"px",marginTop:"-"+Math.round(j.y*(l/e.height))+"px"})};d.Jcrop({onChange:c,onSelect:c,aspectRatio:b.options.width/b.options.height,minSize:[b.options.width,b.options.height],setSelect:[0,0,b.options.width,b.options.height]})},destroy:function(){if(this.dialog){this.dialog.dialog("destroy");this.dialog.remove()}this.image_path=undefined;this.coords=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);