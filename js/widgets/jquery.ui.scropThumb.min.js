(function(a){a.widget("ui.scropThumb",{options:{scrupload:{},additional_width:50,path_key_name:"path",default_select_max:true,data_type:"json"},_create:function(){var b=this;b.element.scrupload(a.extend(b.options.scrupload,{onSelect:function(c,d){b._trigger("onImageSelect",null,{element:b.element,scrupload:d,options:b.options})},onFileComplete:function(f,g){var h=a.parseJSON(g.response),d,i,e,c;if(h.error){b._trigger("onUploadError",null,{element:b.element,response:h,options:b.options});return}c=b._trigger("onLoadImage",null,{element:b.element,response:h,options:b.options});if(c===false){return}b.image_path=h[b.options.path_key_name];var e=a("<div />").appendTo(document.body).css("position","absolute").css("top","-10000px").css("left","-10000px");d=a('<img src="'+b.image_path+'" />').appendTo(e);i=a('<img src="'+b.image_path+'" />').appendTo(e);d.load(function(){var j={width:d.width(),height:d.height()};b.dialog=a("<div />").appendTo(document.body).append(b.options.dialog_template.html());b.dialog.find(".scr_thumb_image").append(d).width(j.width).height(j.height);b.dialog.find(".scr_thumb_preview").width(b.options.width).height(b.options.height).css("overflow","hidden").append(i);e.remove();delete e;b.dialog.dialog(a.extend(b.options.dialog,{width:j.width+b.options.width+b.options.additional_width,close:function(k,l){b._closeDialog()},open:function(k,l){b._initJcrop(d,i,j)}}));b.dialog.find(".sdx_thumb_button").click(function(){a.ajax({type:"POST",url:b.options.url,dataType:b.options.data_type,data:{path:b.image_path,coords:b.coords,size:{w:b.options.width,h:b.options.height}},success:function(k){b._trigger("onCropSuccess",null,{dialog:b.dialog,response:k});b._closeDialog()},error:function(k,m,l){b._trigger("onCropError",null,{element:b.element,xml_http_request:k,text_status:m,error_thrown:l,options:b.options});if(window.console){console.info("Ajax error",k)}b._closeDialog()}});return false});b.dialog.find("*").disableSelection()})}}))},changeRuntime:function(b){this.element.scrupload("start",b)},_closeDialog:function(){this._trigger("onDialogClose",null,{element:this.element,dialog:this.dialog,options:this.options});this.dialog.dialog("destroy");this.dialog.remove();this.dialog=null},_initJcrop:function(d,h,e){var g=false,c,b=this;c=function(i){if(!g){b.dialog.find(".jcrop-holder *").disableSelection();g=true}b.coords=i;var l=e.width/i.w;var k=e.height/i.h;var j=Math.round(l*b.options.width);var m=Math.round(k*b.options.height);h.css({width:j+"px",height:m+"px",marginLeft:"-"+Math.round(i.x*(j/e.width))+"px",marginTop:"-"+Math.round(i.y*(m/e.height))+"px"})};var f=b.options.default_select_max?[0,0,e.width,null]:[0,0,b.options.width,b.options.height];setTimeout(function(){d.Jcrop({onChange:c,onSelect:c,aspectRatio:b.options.width/b.options.height,minSize:[b.options.width,b.options.height],setSelect:f})},100)},destroy:function(){if(this.dialog){this.dialog.dialog("destroy");this.dialog.remove()}this.image_path=undefined;this.coords=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);