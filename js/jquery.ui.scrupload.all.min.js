(function(c,b){if(b.scrupload){return}var d=b.scrupload=b.scrupload||{},a=0;d.SELECTED=1;d.UPLOADING=2;d.FAILED=3;d.DONE=4;d.ERROR_TYPE="TYPE";d.ERROR_CAPACITY="CAPACITY";d.ERROR_HTTP="HTTP";d.ERROR_USER="USER";d.uniqid=function(e){var g=new Date().getTime().toString(32),f;for(f=0;f<5;f++){g+=Math.floor(Math.random()*65535).toString(32)}return("scrupload-"+g).toString(32)};d.buildUrlQuery=function(e,g){var f=c.param(g);if(!f){return e}else{return f.indexOf("?")!=-1?e+"&"+f:e+"?"+f}};d.generateElementId=function(e){var f=e.attr("id");if(f){return f}while(true){f=this.uniqid();if(c("#"+f).length===0){e.attr("id",f);return f}}};d.buildDefaultOptions=function(f){if(f.types){f.post_params.types=f.types}if(f.size_limit){var e=f.size_limit;var g;if(g=e.match(/^([0-9]+)MB$/i)){f.size_limit_byte=g[1]*1024*1024}else{if(g=e.match(/^([0-9]+)KB$/i)){f.size_limit_byte=g[1]*1024}else{if(g=e.match(/^([0-9]+)B?$/i)){f.size_limit_byte=g[1]}else{throw f.size_limit+" is illegal size_limit value."}}}f.post_params.size_limit=f.size_limit;f.post_params.size_limit_byte=f.size_limit_byte}};d.checkTypes=function(e,g){if(e.options.types&&g.type){var h=e.options.types.split("|"),f;if(c.inArray(g.type,h)==-1){g.errors.push({type:scrupload.ERROR_TYPE,params:{file_types:h.join(",")}});g.status=scrupload.FAILED}}};d.checkSize=function(e,f){if(e.options.size_limit_byte&&f.size){if(f.size>e.options.size_limit_byte){f.errors.push({type:scrupload.ERROR_CAPACITY,params:{capacity:e.options.size_limit}});f.status=scrupload.FAILED}}};d.defaultOptions=function(e){return c.extend({},{file_post_name:"file",post_params:{},get_params:{},interval:0},e||{})};d.initButtonEvent=function(e,g){var f=false;g.bind("mouseout.scr",function(){if(f){e._trigger("onButtonOut",null,{element:e.element,runtime:e.runtime,options:e.options});f=false}}).bind("mouseover.scr",function(){if(!f){e._trigger("onButtonOver",null,{element:e.element,runtime:e.runtime,options:e.options});f=true}}).bind("mousedown.scr",function(){e._trigger("onButtonDown",null,{element:e.element,runtime:e.runtime,options:e.options})})};d.removeButtonEvent=function(e){e.unbind("mouseout.scr").unbind("mouseover.scr").unbind("mousedown.scr")};d.createFile=function(f,e){return{id:(e.file_id_prefix||"scrfile-"+(++a)),time:new Date(),filename:f.name||f.fileName,size:f.size,type:d.detectFileType(f),status:this.SELECTED,errors:[],get:c.extend({},e.get_params),post:c.extend({},e.post_params)}};d.detectFileType=function(g){var h,e,f;if(g.type){if(g.type.indexOf("/")==-1){h=g.type.substr(1).toLowerCase()}}if(!h){e=g.name||g.fileName;f=e.lastIndexOf(".");if(f==-1){h=false}else{h=e.substr(f+1).toLowerCase()}}return h};d.onSelect=function(e,f){e._trigger("onSelect",null,{element:e.element,runtime:e.runtime,file:f,options:e.options});if(f.errors.length>0){e._trigger("onError",null,{element:e.element,file:f,runtime:e.runtime,options:e.options})}};d.submitIframForm=function(k,i,e,j){var f=e,h;h=scrupload.createFile({name:i},f.options);(j||c.noop)(h);if(i!="n/a"){scrupload.checkTypes(f,h)}f._trigger("onDialogClose",null,{element:f.element,runtime:f.runtime,selected:[h],options:f.options});scrupload.onSelect(f,h);var l=function(){k.remove();f._resetInterface();f.element.removeClass("scr_uploading");f._trigger("onComplete",null,{element:f.element,uploaded:[h],runtime:f.runtime,options:f.options})};var g=f._trigger("onStartUpload",null,{element:f.element,runtime:f.runtime,queue:h.errors.length===0?[h]:[],options:f.options});if(g===false){l();return}if(h.errors.length==0){var g=f._trigger("onFileStart",null,{element:f.element,runtime:f.runtime,file:h,options:f.options});if(g===false){f._trigger("onFileCancel",null,{element:this.element,runtime:this.runtime,file:h,options:this.options});l();return}k.submit(function(){h.post.id=h.id;h.post.post_name=f.options.file_post_name;c.each(h.post,function(n){k.append('<input type="hidden" name="'+n+'" value="'+this+'" />')});var m=k.attr("action");m=scrupload.buildUrlQuery(m,h.get);k.attr("action",m);h.status=scrupload.UPLOADING;f._trigger("onProgress",null,{element:f.element,runtime:f.runtime,file:h,progress:{percent:0},options:f.options})});k.attr("target",h.id);k.find("input[name=id]").val(h.id);c('<iframe src="about:blank" name="'+h.id+'">').appendTo(document.body).css({width:"1px",height:"1px",position:"absolute",left:"-10000px",top:"-10000px"}).load(function(){var m=c(this),p=c(this.contentWindow.document.body).text();if(p){var n;try{n=c.parseJSON(p)}catch(o){}if(n&&n.errors.length){h.status=d.FAILED;h.errors=n.errors;f._trigger("onError",null,{element:f.element,file:h,runtime:f.runtime,options:f.options})}else{f._trigger("onProgress",null,{element:f.element,file:h,runtime:f.runtime,progress:{percent:100},options:f.options});h.status=scrupload.DONE;f._trigger("onFileComplete",null,{element:f.element,file:h,runtime:f.runtime,response:p,json:n,options:f.options})}}setTimeout(function(){m.remove();l()},0)});k.submit()}else{l()}};d.disableInterface=function(e,f){cover=e.data("disable-cover");if(!cover){cover=c("<div></div>").appendTo(e).css("position","absolute").css("top",0).css("left",0).css("z-index",10000).offset(e.offset()).width(e.width()).height(e.height());e.data("disable-cover",cover)}cover.show()};d.enableInterface=function(e,f){cover=e.data("disable-cover");if(cover){cover.hide()}}})(jQuery,(function(){return this})());(function(b){var a=new RegExp("([^/?]+)\\??[^/]*$");b.widget("ui.scruploadHttp",{options:scrupload.defaultOptions({button_value:"OK"}),_create:function(){var c=this;c.element.addClass("scr_http_container");c.queue_array=[];scrupload.buildDefaultOptions(c.options);c._initInterface();c.runtime={name:"http",object:c.input};c._trigger("onInit",null,{element:c.element,runtime:c.runtime,options:c.options})},_initInterface:function(){var c=this,d;c.container=b("<span></span>").appendTo(c.element);c.input=b('<input type="text">').appendTo(c.container);d=b('<input type="submit" value="'+c.options.button_value+'">').appendTo(c.container);scrupload.initButtonEvent(c,c.container);d.click(function(){var g=b('<form action="'+c.options.url+'" method="post" />'),f="n/a",e=b(this),h=c.input.val();c.element.addClass("scr_uploading");c.input.attr("name",c.options.file_post_name);g.appendTo(b("body")).append(c.container).hide();if(a.exec(h)){f=RegExp.$1}scrupload.submitIframForm(g,f,c,function(i){i.post.filename=f;i.http={uri:h};if(!h.match(/^https?:\/\//)){i.errors.push({type:scrupload.ERROR_HTTP});i.status=scrupload.FAILED}});return false})},_resetInterface:function(){this.container.remove();this._initInterface()},destroy:function(){this.element.removeClass("scr_http_container");this.container.remove();this.queue_array=[];this.input=undefined;b.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);(function(a){a.widget("ui.scruploadHtml4",{options:scrupload.defaultOptions({}),_create:function(){var b=this;b.element.addClass("scr_html4_container");b.queue_array=[];scrupload.buildDefaultOptions(b.options);b._initInterface();b.runtime={name:"html4",object:b.input};b._trigger("onInit",null,{element:b.element,runtime:b.runtime,options:b.options})},_initInterface:function(){var b=this;b._createFormAndInput()},_createFormAndInput:function(){var b=this;b.input=a('<input type="file" />');b.container=a("<span />");b.input.appendTo(b.container.appendTo(b.element));scrupload.initButtonEvent(b,b.container);b.input.change(function(){var e=a('<form action="'+b.options.url+'" method="post" enctype="multipart/form-data" />'),d="n/a",f,c=a(this);b.element.addClass("scr_uploading");c.attr("name",b.options.file_post_name);e.appendTo(a("body")).append(b.container).hide();if(this.value){d=this.value;f=d.match(/[\/\\]([^\/\\]+)$/i);if(f){d=f[1]}}scrupload.submitIframForm(e,d,b)})},_resetInterface:function(){this.container.remove();this._initInterface()},destroy:function(){this.element.removeClass("scr_html4_container");this.container.remove();this.queue_array=[];this.input=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);(function(a){a.widget("ui.scruploadHtml5",{options:scrupload.defaultOptions({mutiple_select:true}),_create:function(){var b=this;b.element.addClass("scr_html5_container");scrupload.buildDefaultOptions(b.options);b._initInterface();b.runtime={name:"html5",object:b.input};b._trigger("onInit",null,{element:b.element,runtime:b.runtime,options:b.options})},_initInterface:function(){var b=this;b.queue_array=[];b.selected_array=[];b.uploaded_array=[];b._createFormAndInput()},_createFormAndInput:function(){var b=this,c;c=b.options.file_post_name;if(b.options.mutiple_select){b.input=a('<input type="file" name="'+c+'" multiple />')}else{b.input=a('<input type="file" name="'+c+'" />')}b.container=a("<span />");b.container.appendTo(b.element);b.input.appendTo(b.container);scrupload.initButtonEvent(b,b.container);b.input.change(function(){var d,e,k="n/a",l,m=a(this),f,h;b.input.attr("disabled","disabled");b.element.addClass("scr_uploading");e=a('<form method="post" enctype="multipart/form-data" />');e.appendTo(b.element).append(b.container);for(var g=0;g<this.files.length;g++){f=scrupload.createFile(this.files[g],b.options);fd=new FormData();fd.append(c,this.files[g]);fd.append("id",f.id);fd.append("post_name",c);f.html5={formData:fd,uri:b.options.url,form:e};scrupload.checkTypes(b,f);scrupload.checkSize(b,f);b.selected_array.push(f)}b._trigger("onDialogClose",null,{element:b.element,runtime:b.runtime,selected:b.selected_array,options:b.options});a.each(b.selected_array,function(){var i=this;scrupload.onSelect(b,i);if(i.errors.length==0){b.queue_array.push(i)}});var j=b._trigger("onStartUpload",null,{element:b.element,runtime:b.runtime,queue:b.queue_array,options:b.options});if(j===false){b._onComplete()}else{b._startNext(0)}})},_upload:function(d){var b=this._onFileStart(d);if(b===false){this._onFileCancel(d);this._startNext(0)}else{for(var c in d.post){if(a.isArray(d.post[c])){a.each(d.post[c],function(){d.html5.formData.append(c,this.toString())})}else{d.html5.formData.append(c,d.post[c])}}d.html5.uri=scrupload.buildUrlQuery(d.html5.uri,d.get);d.html5.form.attr("action",d.html5.uri);var e=new XMLHttpRequest();this._setAjaxEventListener(e,d);e.open("POST",d.html5.uri);e.send(d.html5.formData)}},_onFileStart:function(b){return this._trigger("onFileStart",null,{element:this.element,runtime:this.runtime,file:b,options:this.options})},_onFileCancel:function(b){this._trigger("onFileCancel",null,{element:this.element,runtime:this.runtime,file:b,options:this.options})},_setAjaxEventListener:function(d,c){var b=this;d.upload.addEventListener("progress",function(f){c.status=scrupload.UPLOADING;if(f.lengthComputable){var e=Math.round(f.loaded*100/f.total);b._trigger("onProgress",null,{element:b.element,runtime:b.runtime,file:c,options:b.options,progress:{percent:e,bytes_loaded:f.loaded,bytes_total:f.total}})}},false);d.addEventListener("load",function(h){var f;var e;try{e=a.parseJSON(h.target.responseText)}catch(g){}if(e&&e.errors.length){c.status=scrupload.FAILED;c.errors=e.errors;b._trigger("onError",null,{element:b.element,file:c,runtime:b.runtime,options:b.options})}else{c.status=scrupload.DONE;b._trigger("onFileComplete",null,{element:b.element,runtime:b.runtime,file:c,response:h.target.responseText,json:e,options:b.options});b.uploaded_array.push(c)}b._startNext(b.options.interval)},false)},_startNext:function(c){var b=this;next=b.queue_array.shift();if(next){setTimeout(function(){b._upload(next)},c)}else{b._onComplete()}},_onComplete:function(){this._trigger("onComplete",null,{element:this.element,runtime:this.runtime,uploaded:self.uploaded_array,options:this.options});this._resetInterface()},_resetInterface:function(){this.container.remove();this._initInterface()},destroy:function(){this.element.removeClass("scr_html5_container");this.container.remove();this.queue_array=[];this.input=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);(function(a){a.widget("ui.scrupload",{options:{runtimes:"html5|html4"},_create:function(){var d=this,c,f=d.options.runtimes.split("|"),g,e,b;b=a('<input type="file" />').appendTo("body").hide();c={html5:!!b[0].files,http:true,html4:true};b.remove();f.push("html4");for(e=0;e<f.length;e++){if(c[f[e]]&&d.start(f[e])){break}}},start:function(b){var c=this._getRuntimeName(b);if(this.current_runtime!=b&&this.element[c]){if(this.current_runtime){this.element[this._getRuntimeName(this.current_runtime)]("destroy")}this.element[c](this.options);this.current_runtime=b;return true}return false},_getRuntimeName:function(b){return"scrupload"+b.substr(0,1).toUpperCase()+b.substr(1)},destroy:function(){this.element[this._getRuntimeName(this.current_runtime)]("destroy");this.current_runtime=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);