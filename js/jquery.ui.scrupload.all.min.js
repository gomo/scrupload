(function(c,b){if(b.scrupload){return}var d=b.scrupload=b.scrupload||{},a=0;d.SELECTED=1;d.UPLOADING=2;d.FAILED=3;d.DONE=4;d.ERROR_TYPE="TYPE";d.ERROR_CAPACITY="CAPACITY";d.ERROR_HTTP="HTTP";d.ERROR_USER="USER";d.uniqid=function(g){var f=new Date().getTime().toString(32),e;for(e=0;e<5;e++){f+=Math.floor(Math.random()*65535).toString(32)}return("scrupload-"+f).toString(32)};d.buildUrlQuery=function(e,g){var f=c.param(g);if(!f){return e}else{return f.indexOf("?")!=-1?e+"&"+f:e+"?"+f}};d.generateElementId=function(e){var f=e.attr("id");if(f){return f}while(true){f=this.uniqid();if(c("#"+f).length===0){e.attr("id",f);return f}}};d.buildDefaultOptions=function(g){if(g.types){g.post_params.types=g.types}if(g.size_limit){var f=g.size_limit;var e;if(e=f.match(/^([0-9]+)MB$/i)){g.size_limit_byte=e[1]*1024*1024}else{if(e=f.match(/^([0-9]+)KB$/i)){g.size_limit_byte=e[1]*1024}else{if(e=f.match(/^([0-9]+)B?$/i)){g.size_limit_byte=e[1]}else{throw g.size_limit+" is illegal size_limit value."}}}g.post_params.size_limit=g.size_limit;g.post_params.size_limit_byte=g.size_limit_byte}};d.checkTypes=function(h,f){if(h.options.types&&f.type){var g=h.options.types.split("|"),e;if(c.inArray(f.type,g)==-1){f.errors.push({type:scrupload.ERROR_TYPE,params:{file_types:g.join(",")}});f.status=scrupload.FAILED}}};d.checkSize=function(f,e){if(f.options.size_limit_byte&&e.size){if(e.size>f.options.size_limit_byte){e.errors.push({type:scrupload.ERROR_CAPACITY,params:{capacity:f.options.size_limit}});e.status=scrupload.FAILED}}};d.defaultOptions=function(e){return c.extend({},{file_post_name:"file",post_params:{},get_params:{},interval:0},e||{})};d.initButtonEvent=function(g,f){var e=false;f.bind("mouseout.scr",function(){if(e){g._trigger("onButtonOut",null,{element:g.element,runtime:g.runtime,options:g.options});e=false}}).bind("mouseover.scr",function(){if(!e){g._trigger("onButtonOver",null,{element:g.element,runtime:g.runtime,options:g.options});e=true}}).bind("mousedown.scr",function(){g._trigger("onButtonDown",null,{element:g.element,runtime:g.runtime,options:g.options})})};d.removeButtonEvent=function(e){e.unbind("mouseout.scr").unbind("mouseover.scr").unbind("mousedown.scr")};d.createFile=function(f,e){return{id:(e.file_id_prefix||"scrfile-"+(++a)),time:new Date(),filename:f.name||f.fileName,size:f.size,type:d.detectFileType(f),status:this.SELECTED,errors:[],get:c.extend({},e.get_params),post:c.extend({},e.post_params)}};d.detectFileType=function(g){var h,e,f;if(g.type){if(g.type.indexOf("/")==-1){h=g.type.substr(1).toLowerCase()}}if(!h){e=g.name||g.fileName;f=e.lastIndexOf(".");if(f==-1){h=false}else{h=e.substr(f+1).toLowerCase()}}return h};d.onSelect=function(f,e){f._trigger("onSelect",null,{element:f.element,runtime:f.runtime,file:e,options:f.options});if(e.errors.length>0){f._trigger("onError",null,{element:f.element,file:e,runtime:f.runtime,options:f.options})}};d.submitIframForm=function(j,f,k,i){var e=k,h;h=scrupload.createFile({name:f},e.options);(i||c.noop)(h);if(f!="n/a"){scrupload.checkTypes(e,h)}e._trigger("onDialogClose",null,{element:e.element,runtime:e.runtime,selected:[h],options:e.options});scrupload.onSelect(e,h);var l=function(){j.remove();e._resetInterface();e.element.removeClass("scr_uploading");e._trigger("onComplete",null,{element:e.element,uploaded:[h],runtime:e.runtime,options:e.options})};var g=e._trigger("onStartUpload",null,{element:e.element,runtime:e.runtime,queue:h.errors.length===0?[h]:[],options:e.options});if(g===false){l();return}if(h.errors.length==0){var g=e._trigger("onFileStart",null,{element:e.element,runtime:e.runtime,file:h,options:e.options});if(g===false){e._trigger("onFileCancel",null,{element:this.element,runtime:this.runtime,file:h,options:this.options});l();return}j.submit(function(){h.post.id=h.id;h.post.post_name=e.options.file_post_name;c.each(h.post,function(n){j.append('<input type="hidden" name="'+n+'" value="'+this+'" />')});var m=j.attr("action");m=scrupload.buildUrlQuery(m,h.get);j.attr("action",m);h.status=scrupload.UPLOADING;e._trigger("onProgress",null,{element:e.element,runtime:e.runtime,file:h,progress:{percent:0},options:e.options})});j.attr("target",h.id);j.find("input[name=id]").val(h.id);c('<iframe src="about:blank" name="'+h.id+'">').appendTo(document.body).css({width:"1px",height:"1px",position:"absolute",left:"-10000px",top:"-10000px"}).load(function(){var n=c(this),p=c(this.contentWindow.document.body).text();if(p){var m;try{m=c.parseJSON(p)}catch(o){}if(m&&m.errors.length){h.status=d.FAILED;h.errors=m.errors;e._trigger("onError",null,{element:e.element,file:h,runtime:e.runtime,options:e.options})}else{e._trigger("onProgress",null,{element:e.element,file:h,runtime:e.runtime,progress:{percent:100},options:e.options});h.status=scrupload.DONE;e._trigger("onFileComplete",null,{element:e.element,file:h,runtime:e.runtime,response:p,json:m,options:e.options})}}setTimeout(function(){n.remove();l()},0)});j.submit()}else{l()}};d.disableInterface=function(f,e){cover=f.data("disable-cover");if(!cover){cover=c("<div></div>").appendTo(f).css("position","absolute").css("top",0).css("left",0).css("z-index",10000).offset(f.offset()).width(f.width()).height(f.height());f.data("disable-cover",cover)}cover.show()};d.enableInterface=function(f,e){cover=f.data("disable-cover");if(cover){cover.hide()}}})(jQuery,(function(){return this})());(function(b){var a=new RegExp("([^/?]+)\\??[^/]*$");b.widget("ui.scruploadHttp",{options:scrupload.defaultOptions({button_value:"OK"}),_create:function(){var c=this;c.element.addClass("scr_http_container");c.queue_array=[];scrupload.buildDefaultOptions(c.options);c._initInterface();c.runtime={name:"http",object:c.input};c._trigger("onInit",null,{element:c.element,runtime:c.runtime,options:c.options})},_initInterface:function(){var c=this,d;c.container=b("<span></span>").appendTo(c.element);c.input=b('<input type="text">').appendTo(c.container);d=b('<input type="submit" value="'+c.options.button_value+'">').appendTo(c.container);scrupload.initButtonEvent(c,c.container);d.click(function(){var g=b('<form action="'+c.options.url+'" method="post" />'),e="n/a",f=b(this),h=c.input.val();c.element.addClass("scr_uploading");c.input.attr("name",c.options.file_post_name);g.appendTo(b("body")).append(c.container).hide();if(a.exec(h)){e=RegExp.$1}scrupload.submitIframForm(g,e,c,function(i){i.post.filename=e;i.http={uri:h};if(!h.match(/^https?:\/\//)){i.errors.push({type:scrupload.ERROR_HTTP});i.status=scrupload.FAILED}});return false})},_resetInterface:function(){this.container.remove();this._initInterface()},destroy:function(){this.element.removeClass("scr_http_container");this.container.remove();this.queue_array=[];this.input=undefined;b.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);(function(a){a.widget("ui.scruploadHtml4",{options:scrupload.defaultOptions({}),_create:function(){var b=this;b.element.addClass("scr_html4_container");b.queue_array=[];scrupload.buildDefaultOptions(b.options);b._initInterface();b.runtime={name:"html4",object:b.input};b._trigger("onInit",null,{element:b.element,runtime:b.runtime,options:b.options})},_initInterface:function(){var b=this;b._createFormAndInput()},_createFormAndInput:function(){var b=this;b.input=a('<input type="file" />');b.container=a("<span />");b.input.appendTo(b.container.appendTo(b.element));scrupload.initButtonEvent(b,b.container);b.input.change(function(){var c=this;setTimeout(function(){var g=a('<form action="'+b.options.url+'" method="post" enctype="multipart/form-data" />'),f="n/a",d,e=a(c);b.element.addClass("scr_uploading");e.attr("name",b.options.file_post_name);g.appendTo(a("body")).append(b.container).hide();if(c.value){f=c.value;d=f.match(/[\/\\]([^\/\\]+)$/i);if(d){f=d[1]}}scrupload.submitIframForm(g,f,b)},0)})},_resetInterface:function(){this.container.remove();this._initInterface()},destroy:function(){this.element.removeClass("scr_html4_container");this.container.remove();this.queue_array=[];this.input=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);(function(a){a.widget("ui.scruploadHtml5",{options:scrupload.defaultOptions({mutiple_select:true}),_create:function(){var b=this;b.element.addClass("scr_html5_container");scrupload.buildDefaultOptions(b.options);b._initInterface();b.runtime={name:"html5",object:b.input};b._trigger("onInit",null,{element:b.element,runtime:b.runtime,options:b.options})},_initInterface:function(){var b=this;b.queue_array=[];b.selected_array=[];b.uploaded_array=[];b._createFormAndInput()},_createFormAndInput:function(){var b=this,d;var c;d=b.options.file_post_name;if(b.options.mutiple_select){b.input=a('<input type="file" name="'+d+'" multiple />')}else{b.input=a('<input type="file" name="'+d+'" />')}b.container=a("<div />");b.container.appendTo(b.element);c=a('<form method="post" enctype="multipart/form-data" />');c.appendTo(b.container).append(b.input);scrupload.initButtonEvent(b,b.container);b.input.change(function(){var e=this;setTimeout(function(){var k,h="n/a",f,g=a(e),m,n;b.input.attr("disabled","disabled");b.element.addClass("scr_uploading");for(var l=0;l<e.files.length;l++){m=scrupload.createFile(e.files[l],b.options);fd=new FormData();fd.append(d,e.files[l]);fd.append("id",m.id);fd.append("post_name",d);m.html5={formData:fd,uri:b.options.url,form:c};scrupload.checkTypes(b,m);scrupload.checkSize(b,m);b.selected_array.push(m)}b._trigger("onDialogClose",null,{element:b.element,runtime:b.runtime,selected:b.selected_array,options:b.options});a.each(b.selected_array,function(){var i=this;scrupload.onSelect(b,i);if(i.errors.length==0){b.queue_array.push(i)}});var j=b._trigger("onStartUpload",null,{element:b.element,runtime:b.runtime,queue:b.queue_array,options:b.options});if(j===false){b._onComplete()}else{b._startNext(0)}},0)})},_upload:function(d){var b=this._onFileStart(d);if(b===false){this._onFileCancel(d);this._startNext(0)}else{for(var c in d.post){if(a.isArray(d.post[c])){a.each(d.post[c],function(){d.html5.formData.append(c,this.toString())})}else{d.html5.formData.append(c,d.post[c])}}d.html5.uri=scrupload.buildUrlQuery(d.html5.uri,d.get);d.html5.form.attr("action",d.html5.uri);var e=new XMLHttpRequest();this._setAjaxEventListener(e,d);e.open("POST",d.html5.uri);e.send(d.html5.formData)}},_onFileStart:function(b){return this._trigger("onFileStart",null,{element:this.element,runtime:this.runtime,file:b,options:this.options})},_onFileCancel:function(b){this._trigger("onFileCancel",null,{element:this.element,runtime:this.runtime,file:b,options:this.options})},_setAjaxEventListener:function(d,c){var b=this;d.upload.addEventListener("progress",function(f){c.status=scrupload.UPLOADING;if(f.lengthComputable){var e=Math.round(f.loaded*100/f.total);b._trigger("onProgress",null,{element:b.element,runtime:b.runtime,file:c,options:b.options,progress:{percent:e,bytes_loaded:f.loaded,bytes_total:f.total}})}},false);d.addEventListener("load",function(h){var f;var e;try{e=a.parseJSON(h.target.responseText)}catch(g){}if(e&&e.errors.length){c.status=scrupload.FAILED;c.errors=e.errors;b._trigger("onError",null,{element:b.element,file:c,runtime:b.runtime,options:b.options})}else{c.status=scrupload.DONE;b._trigger("onFileComplete",null,{element:b.element,runtime:b.runtime,file:c,response:h.target.responseText,json:e,options:b.options});b.uploaded_array.push(c)}b._startNext(b.options.interval)},false)},_startNext:function(c){var b=this;next=b.queue_array.shift();if(next){setTimeout(function(){b._upload(next)},c)}else{b._onComplete()}},_onComplete:function(){this.element.removeClass("scr_uploading");this._trigger("onComplete",null,{element:this.element,runtime:this.runtime,uploaded:self.uploaded_array,options:this.options});this._resetInterface()},_resetInterface:function(){this.container.remove();this._initInterface()},destroy:function(){this.element.removeClass("scr_html5_container");this.container.remove();this.queue_array=[];this.input=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);(function(a){a.widget("ui.scrupload",{options:{runtimes:"html5|html4"},_create:function(){var d=this,c,f=d.options.runtimes.split("|"),g,e,b;b=a('<input type="file" />').appendTo("body").hide();c={html5:!!b[0].files,http:true,html4:true};b.remove();f.push("html4");for(e=0;e<f.length;e++){if(c[f[e]]&&d.start(f[e])){break}}},start:function(b){var c=this._getRuntimeName(b);if(this.current_runtime!=b&&this.element[c]){if(this.current_runtime){this.element[this._getRuntimeName(this.current_runtime)]("destroy")}this.element[c](this.options);this.current_runtime=b;return true}return false},_getRuntimeName:function(b){return"scrupload"+b.substr(0,1).toUpperCase()+b.substr(1)},destroy:function(){this.element[this._getRuntimeName(this.current_runtime)]("destroy");this.current_runtime=undefined;a.Widget.prototype.destroy.apply(this,arguments);return this}})})(jQuery);